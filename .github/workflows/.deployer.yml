name: .Terraform Deployer

on:
  workflow_call:
    inputs:
      ### Required
      environment_name:
        description: "The name of the environment to deploy to"
        required: true
        default: "dev"
        type: string
      command:
        description: "The terragrunt command to run"
        required: true
        default: "apply"
        type: string
      tag:
        description: "The tag of the containers to deploy"
        default: "latest"
        type: string
        required: false
      app_env:
        required: false
        type: string
        description: "The APP env separates between Azure ENV and Actual APP, since Azure dev is where PR, and TEST is deployed"
      stack_prefix:
        required: true
        type: string
        description: "The stack prefix to use for the resources"

env:
  TF_VERSION: 1.12.2
  TF_LOG: ERROR
  AZURE_REGION: Canada Central
permissions:
  id-token: write # This is required for requesting the JWT
  contents: write # This is required for actions/checkout
jobs:
  infra:
    environment: ${{ inputs.environment_name }}
    name: Terraform ${{inputs.command}}  ${{ inputs.environment_name }}
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: print ip
        run: curl https://ifconfig.me
      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Make deploy script executable
        shell: bash
        run: chmod +x ./infra/deploy-terraform.sh

      - name: Populate shared env
        shell: bash
        run: |
          set -euo pipefail

          echo "CI=true" >> "$GITHUB_ENV"
          echo "ARM_USE_OIDC=true" >> "$GITHUB_ENV"

          echo "BACKEND_RESOURCE_GROUP=${{ secrets.VNET_RESOURCE_GROUP_NAME }}" >> "$GITHUB_ENV"
          echo "BACKEND_STORAGE_ACCOUNT=${{ vars.STORAGE_ACCOUNT_NAME }}" >> "$GITHUB_ENV"
          echo "BACKEND_CONTAINER_NAME=tfstate" >> "$GITHUB_ENV"
          echo "BACKEND_STATE_KEY=${{ inputs.stack_prefix }}/${{ inputs.app_env }}/terraform.tfstate" >> "$GITHUB_ENV"

          echo "TF_VAR_target_env=${{ inputs.environment_name }}" >> "$GITHUB_ENV"
          echo "TF_VAR_azure_subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> "$GITHUB_ENV"
          echo "TF_VAR_azure_tenant_id=${{ secrets.AZURE_TENANT_ID }}" >> "$GITHUB_ENV"
          echo "TF_VAR_azure_client_id=${{ secrets.AZURE_CLIENT_ID }}" >> "$GITHUB_ENV"

          echo "TF_VAR_subscription_id=${{ secrets.AZURE_SUBSCRIPTION_ID }}" >> "$GITHUB_ENV"
          echo "TF_VAR_tenant_id=${{ secrets.AZURE_TENANT_ID }}" >> "$GITHUB_ENV"
          echo "TF_VAR_client_id=${{ secrets.AZURE_CLIENT_ID }}" >> "$GITHUB_ENV"

          echo "TF_VAR_vnet_resource_group_name=${{ secrets.VNET_RESOURCE_GROUP_NAME }}" >> "$GITHUB_ENV"
          echo "TF_VAR_vnet_name=${{ secrets.VNET_NAME }}" >> "$GITHUB_ENV"
          echo "TF_VAR_vnet_address_space=${{ secrets.VNET_ADDRESS_SPACE }}" >> "$GITHUB_ENV"

          echo "TF_VAR_flyway_image=ghcr.io/${{ github.repository }}/migrations:${{ inputs.tag }}" >> "$GITHUB_ENV"
          echo "TF_VAR_api_image=ghcr.io/${{ github.repository }}/backend:${{ inputs.tag }}" >> "$GITHUB_ENV"
          echo "TF_VAR_frontend_image=ghcr.io/${{ github.repository }}/frontend:${{ inputs.tag }}" >> "$GITHUB_ENV"
          echo "TF_VAR_azure_proxy_image=ghcr.io/${{ github.repository }}/azure-proxy/chisel:${{ inputs.tag }}" >> "$GITHUB_ENV"

          echo "TF_VAR_stack_prefix=${{ inputs.stack_prefix }}" >> "$GITHUB_ENV"
          echo "TF_VAR_app_env=${{ inputs.app_env }}" >> "$GITHUB_ENV"
          echo "TF_VAR_app_name=${{ inputs.stack_prefix }}-${{ inputs.app_env }}" >> "$GITHUB_ENV"
          echo "TF_VAR_location=${{ env.AZURE_REGION }}" >> "$GITHUB_ENV"

          echo "TF_VAR_use_oidc=true" >> "$GITHUB_ENV"
          echo "TF_VAR_repo_name=${{ github.event.repository.name }}" >> "$GITHUB_ENV"
          echo "TF_VAR_resource_group_name=${{ github.event.repository.name }}-${{ inputs.app_env }}" >> "$GITHUB_ENV"

          echo "TF_VAR_common_tags<<EOF" >> "$GITHUB_ENV"
          echo '{"environment":"${{ inputs.environment_name }}","stack_prefix":"${{ inputs.stack_prefix }}","app_env":"${{ inputs.app_env }}","repo_name":"${{ github.event.repository.name }}"}' >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      - name: Deploy Base Infrastructure
        id: deploy-base-infra
        if: ${{ inputs.command == 'apply' }}
        shell: bash
        working-directory: infra
        run: |
          set -euo pipefail

          ./deploy-terraform.sh ${{ inputs.command }} -var-file=${{ inputs.environment_name }}.tfvars -target=module.azure_proxy
          PROXY_AUTH=$(terraform output -raw proxy_auth)
          PROXY_URL=$(terraform output -raw azure_proxy_url)

          # Prevent secrets from appearing in GitHub Actions logs
          echo "::add-mask::$PROXY_AUTH"
          echo "::add-mask::$PROXY_URL"

          echo "PROXY_AUTH=$PROXY_AUTH" >> "$GITHUB_ENV"
          echo "PROXY_URL=$PROXY_URL" >> "$GITHUB_ENV"
          # now , wait for proxy to be ready by checking health endpoint and waiting in a loop with exponential backoff for 10 retries
          echo "Waiting for Azure Proxy to be ready..."
          RETRIES=10
          ready=0
          for i in $(seq 1 $RETRIES); do
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${PROXY_URL%/}/healthz" || true)
            if [ "$STATUS_CODE" -eq 200 ]; then
              echo "Azure Proxy is ready!"
              ready=1
              break
            else
              echo "Attempt $i/$RETRIES: Azure Proxy not ready yet (status code: $STATUS_CODE). Retrying in $((2 ** i)) seconds..."
              sleep $((2 ** i))
            fi
          done

          if [ "$ready" -ne 1 ]; then
            echo "ERROR: Azure Proxy did not become ready after $RETRIES attempts."
            exit 1
          fi
      - name: Run Chisel Proxy Client In Docker
        if: ${{ inputs.command == 'apply' }}
        shell: bash
        run: |
          docker network create proxy-net >/dev/null 2>&1 || true
          docker run -d --name chisel-client --network proxy-net jpillora/chisel:1.11 client --auth "$PROXY_AUTH" "$PROXY_URL" 0.0.0.0:1080:socks
          docker logs chisel-client
      - name: Run Privoxy In Docker
        if: ${{ inputs.command == 'apply' }}
        shell: bash
        run: |
          docker network create proxy-net >/dev/null 2>&1 || true
          docker run -d --name privoxy --network proxy-net -p 127.0.0.1:8118:8118 -e SOCKS_HOST=chisel-client -e SOCKS_PORT=1080 ghcr.io/${{ github.repository }}/azure-proxy/privoxy:${{ inputs.tag }}
          docker logs privoxy
      - name: Deploy Entire Infrastructure
        shell: bash
        if: ${{ inputs.command == 'apply' }}
        working-directory: infra
        env:
          HTTP_PROXY: "http://127.0.0.1:8118"
          HTTPS_PROXY: "http://127.0.0.1:8118"
        run: |
          curl --proxy http://127.0.0.1:8118 https://ifconfig.me
          ./deploy-terraform.sh ${{ inputs.command }} -var-file=${{ inputs.environment_name }}.tfvars
      - name: Terraform Plan or Destroy
        shell: bash
        if: ${{ inputs.command != 'apply' }}
        working-directory: infra
        run: |
          ./deploy-terraform.sh ${{ inputs.command }} -var-file=${{ inputs.environment_name }}.tfvars
